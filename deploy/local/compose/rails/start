#!/bin/bash
# deploy/local/compose/rails/start

set -o errexit
set -o pipefail
set -o nounset

# Install gems if needed (volumes may override build-time gems)
bundle check || bundle install

# Remove stale PID file if it exists
rm -f /app/tmp/pids/server.pid

# Only create/migrate DB if it doesn't exist or has pending migrations
if ! bundle exec rails db:version &>/dev/null; then
  echo "Database not found, creating..."
  bundle exec rails db:create db:schema:load
elif bundle exec rails db:migrate:status | grep -q "down"; then
  echo "Running pending migrations..."
  bundle exec rails db:migrate
fi

# Run the development server
exec bundle exec rails server -b 0.0.0.0 -p 8000
