# deploy/local/setup.yml
name: rails_cruella_local

volumes:
  postgres_data: {}
  redis_data: {}
  bootsnap_cache: {}
  bundle_cache: {}
  garage_meta: {}
  garage_data: {}

services:
  postgres:
    build:
      context: ../..
      dockerfile: ./deploy/production/compose/postgres/Dockerfile
    image: postgres
    container_name: postgres
    volumes:
      - postgres_data:/var/lib/postgresql
    env_file:
      - ./.envs/.postgres

  redis:
    image: docker.io/redis:8
    container_name: redis
    volumes:
      - redis_data:/data

  garage:
    image: dxflrs/garage:v2.2.0
    container_name: garage
    volumes:
      - ../../deploy/local/compose/garage/garage.toml:/etc/garage.toml:ro
      - garage_meta:/var/lib/garage/meta
      - garage_data:/var/lib/garage/data
    healthcheck:
      test: ["CMD", "/garage", "status"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  create_garage_bucket:
    build:
      context: ../..
      dockerfile: ./deploy/local/compose/garage/Dockerfile.init
    container_name: create_garage_bucket
    volumes:
      - ../../deploy/local/compose/garage/garage.toml:/etc/garage.toml:ro
      - garage_meta:/var/lib/garage/meta
      - garage_data:/var/lib/garage/data
    depends_on:
      garage:
        condition: service_healthy
    env_file:
      - ./.envs/.garage
    entrypoint: >
      sh -c "
        NODE_ID=$$(/garage node id -q 2>/dev/null | cut -d@ -f1) &&
        /garage layout assign -z local -c 1G $$NODE_ID || true &&
        /garage layout apply --version 1 || true &&
        /garage bucket create local-rails-cruella || true &&
        /garage key import --yes -n local-rails-cruella-key $$GARAGE_ACCESS_KEY_ID $$GARAGE_SECRET_ACCESS_KEY || true &&
        /garage bucket allow --read --write --owner local-rails-cruella --key local-rails-cruella-key
      "

  rails_migrations:
    build:
      context: ../..
      dockerfile: ./deploy/local/compose/rails/Dockerfile
    image: rails
    container_name: rails_migrations
    depends_on:
      - postgres
    volumes:
      - ../../:/app:z
      - bootsnap_cache:/app/tmp/cache/bootsnap
      - bundle_cache:/usr/local/bundle
    env_file:
      - ./.envs/.rails
    command: /migrate

  setup_complete:
    image: alpine:latest
    container_name: setup_complete
    depends_on:
      rails_migrations:
        condition: service_completed_successfully
      create_garage_bucket:
        condition: service_completed_successfully
    command: sh -c "echo 'Setup completed successfully' && exit 0"
