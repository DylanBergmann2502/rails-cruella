# .github/workflows/ci.yml
name: CI

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

on:
  pull_request:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]
  push:
    branches: ["master", "main"]
    paths-ignore: ["docs/**"]

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build Rails image
        run: docker compose -f deploy/local/web.yml build rails

      - name: StandardRB
        run: docker compose -f deploy/local/web.yml run --rm rails bundle exec standardrb

      - name: Brakeman
        run: docker compose -f deploy/local/web.yml run --rm rails bundle exec brakeman --no-pager

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Create env files
        run: |
          mkdir -p deploy/local/.envs

          cat > deploy/local/.envs/.postgres << EOF
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_DB=rails_cruella_test
          POSTGRES_USER=ci
          POSTGRES_PASSWORD=ci
          EOF

          cat > deploy/local/.envs/.rails << EOF
          RAILS_ENV=development
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_DB=rails_cruella_test
          POSTGRES_USER=ci
          POSTGRES_PASSWORD=ci
          RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }}
          SECRET_KEY_BASE=${{ secrets.SECRET_KEY_BASE }}
          RAILS_MAX_THREADS=5
          RAILS_HOST=0.0.0.0
          REDIS_URL=redis://redis:6379/0
          EOF

          cat > deploy/local/.envs/.garage << EOF
          GARAGE_ACCESS_KEY_ID=placeholder
          GARAGE_SECRET_ACCESS_KEY=placeholder
          EOF

      - name: Build Rails image
        run: docker compose -f deploy/local/web.yml build rails

      - name: Start services
        run: docker compose -f deploy/local/web.yml up -d postgres redis

      - name: Run migrations
        run: docker compose -f deploy/local/web.yml run --rm -e RAILS_ENV=test rails bundle exec rails db:create db:migrate

      - name: Run tests
        run: docker compose -f deploy/local/web.yml run --rm -e RAILS_ENV=test rails bundle exec rspec

      - name: Check swagger is up to date
        run: |
          docker compose -f deploy/local/web.yml run --rm -e RAILS_ENV=test rails bundle exec rails rswag:specs:swaggerize
          git diff --exit-code swagger/v1/swagger.json || (echo "swagger.json is out of date â€” run ./bin/run swagger" && exit 1)

      - name: Tear down
        if: always()
        run: docker compose -f deploy/local/web.yml down -v
